/* 1 */

CREATE OR REPLACE FUNCTION TOTAL_ESTUDIANTES(NUM_ABO ABOGADOS.TRAB_CODIGO%TYPE)
RETURN NUMBER
IS
    TOTAL NUMBER;
BEGIN 
    SELECT COUNT(*) INTO TOTAL
    FROM ESTUDIANTES
    WHERE UPPER(ABO_TRAB_CODIGO) = UPPER(NUM_ABO);
    
    RETURN TOTAL;
END;
/

SELECT TRAB_CODIGO, TOTAL_ESTUDIANTES(TRAB_CODIGO) FROM ABOGADOS;

/* 2 */

CREATE OR REPLACE FUNCTION TOTAL_CASOS(NUM_CAS ABOGADOS.TRAB_CODIGO%TYPE)
RETURN NUMBER
IS
    TOTAL NUMBER;
BEGIN 
    SELECT COUNT(*) INTO TOTAL
    FROM ATIENDE
    WHERE UPPER(ABO_TRAB_CODIGO) = UPPER(NUM_CAS);
    
    RETURN TOTAL;
END;
/

SELECT DISTINCT ABO_TRAB_CODIGO, TOTAL_CASOS(ABO_TRAB_CODIGO) FROM ATIENDE;

/* 3 */

SET SERVEROUTPUT ON
CREATE OR REPLACE PROCEDURE TOTAL_EXPEDIENTES_ABOGADO (NUM_ABO VARCHAR)
IS
    CURSOR AUX_CUR IS
        SELECT  CLIEN_DNI, COD_EXPEDIENTE
        FROM ATIENDE
        WHERE UPPER(ABO_TRAB_CODIGO) = UPPER(NUM_ABO)
        ORDER BY COD_EXPEDIENTE;
        
        EXISTE NUMBER;
        NOMBRE VARCHAR(10); 
BEGIN 
    EXISTE := 0;

    SELECT COUNT(*) INTO EXISTE
    FROM ABOGADOS
    WHERE UPPER(TRAB_CODIGO)= UPPER(NUM_ABO);

    IF EXISTE = 0 THEN
        DBMS_OUTPUT.PUT_LINE('NO HEMOS ENCONTRADO AL ABOGADO CON EL CODIGO: ' || NUM_ABO);
    ELSE
        SELECT NOMBRE INTO NOMBRE
        FROM TRABAJADORES
        WHERE UPPER(CODIGO) = UPPER(NUM_ABO);
    
        DBMS_OUTPUT.PUT_LINE('-----------------------');
        DBMS_OUTPUT.PUT_LINE('EL ABOGADO: ' || NOMBRE || ' Y EL CODIGO ' || NUM_ABO);
        DBMS_OUTPUT.PUT_LINE('-----------------------');
        
        FOR AUX IN AUX_CUR LOOP
            DBMS_OUTPUT.PUT_LINE(AUX.CLIEN_DNI || ' ' || AUX.COD_EXPEDIENTE);
        END LOOP;
    END IF;
END;
/

EXECUTE TOTAL_EXPEDIENTES_ABOGADO ('X00001'); 

/* 4 */

SET SERVEROUTPUT ON
CREATE OR REPLACE PROCEDURE LISTADO_VISITAS (NUM_ABO VARCHAR, DNI_DE VARCHAR)
IS
    CURSOR AUX_CUR IS
        SELECT COD_EXPEDIENTE, FECHA_VISITA
        FROM VISITAR
        WHERE UPPER(ABO_TRAB_CODIGO) = UPPER(NUM_ABO) AND UPPER(DNI_DEMANDANTE) = UPPER(DNI_DE)
        ORDER BY COD_EXPEDIENTE;
        
        CONTADOR NUMBER := 1; 
BEGIN     
        DBMS_OUTPUT.PUT_LINE('-----------------------');
        DBMS_OUTPUT.PUT_LINE('EL ABOGADO: ' || NUM_ABO || ' SE REUNIO CON EL CLIENTE: ' || dni_de);
        DBMS_OUTPUT.PUT_LINE('-----------------------');
        
        FOR AUX IN AUX_CUR LOOP
            DBMS_OUTPUT.PUT_LINE('VISITA '||CONTADOR|| ': '|| AUX.COD_EXPEDIENTE || ' ' || AUX.FECHA_VISITA);
        END LOOP;
        
        DBMS_OUTPUT.PUT_LINE('-----------------------');
        DBMS_OUTPUT.PUT_LINE('TOTAL: '||CONTADOR); 
        
END;
/

EXECUTE LISTADO_VISITAS ('X00001','56748912Z'); 

/* 5 */


SET SERVEROUTPUT ON
CREATE OR REPLACE TRIGGER INSER_ESTUDIANTE
    BEFORE INSERT ON ESTUDIANTES
    FOR EACH ROW
DECLARE
    EXISTE NUMBER:= 0;

BEGIN
    IF INSERTING THEN
        SELECT COUNT(*) INTO EXISTE
        FROM ABOGADOS
        WHERE TRAB_CODIGO = :NEW.TRAB_CODIGO;
        
        IF EXISTE != 0 THEN
            RAISE_APPLICATION_ERROR(-20001, 'NO SE PUDO REALIZAR EL ALTA. 
            EL EMPLEADO CON CODIGO: ' || :NEW.TRAB_CODIGO || 'YA ES ABOGADO.');
        END IF;
    END IF;
END;
/

---------------------------------------------------------------------------------

SET SERVEROUTPUT ON
CREATE OR REPLACE TRIGGER INSER_ABOGADO
    BEFORE INSERT ON ABOGADOS
    FOR EACH ROW
DECLARE
    EXISTE NUMBER:= 1;

BEGIN
    IF INSERTING THEN
        SELECT COUNT(*) INTO EXISTE
        FROM ABOGADOS
        WHERE TRAB_CODIGO = :NEW.TRAB_CODIGO;
        
        IF EXISTE != 0 THEN
            RAISE_APPLICATION_ERROR(-20001, 'NO SE PUDO REALIZAR EL ALTA. 
            EL EMPLEADO CON CODIGO: ' || :NEW.TRAB_CODIGO || 'YA ES ESTUDIANTE.');
        END IF;
    END IF;
END;
/

----------------------------------------------------------------------------------

SET SERVEROUTPUT ON
CREATE OR REPLACE TRIGGER INSER_JUICIO
    BEFORE INSERT ON JUICIO
    FOR EACH ROW
DECLARE
    EXISTE NUMBER:= 0;
    NUM_VISI NUMBER:=0;

BEGIN
    IF INSERTING THEN
        SELECT COUNT(*) INTO NUM_VISI
        FROM VISITAR
        WHERE COD_EXPEDIENTE = :NEW.COD_EXPEDIENTE;
        
        IF INSERTING THEN
            SELECT COUNT(*) INTO EXISTE
            FROM JUICIO
            WHERE NUM_VISI = 0;
        
            IF EXISTE != 0 THEN
                RAISE_APPLICATION_ERROR(-20001, 'NO SE PUEDE IR A JUICIO AUN. 
                EL EXPEDIENTE CON CODIGO: ' || :NEW.COD_EXPEDIENTE || ' NO HA REALIZADO NINGUNA VISITA.');
            END IF;
        END IF;      
        
    END IF;
END;
/

INSERT INTO EXPEDIENTE VALUES('LEVE', 'E0007', '11111111A');
INSERT INTO JUICIO VALUES('44444444B', '56748912Z', 'X00001', '11111111A', 'E0007');

/* 6 */

CREATE OR REPLACE PROCEDURE LISTADO_CLIEN (DNI_C VARCHAR)
IS
    CURSOR AUX_CUR IS
        SELECT TIPO_DE_FALTA, CODIGO_EXPEDIENTE
        FROM EXPEDIENTE
        WHERE CLIEN_DNI = DNI_C
        ORDER BY CODIGO_EXPEDIENTE;
        
    CONTADOR NUMBER:=1;

BEGIN
    DBMS_OUTPUT.PUT_LINE('------------------------------');
    DBMS_OUTPUT.PUT_LINE('EL CLIENTE: ' || DNI_C);
    DBMS_OUTPUT.PUT_LINE('------------------------------');
    
    FOR AUX IN AUX_CUR LOOP
        DBMS_OUTPUT.PUT_LINE(CONTADOR || '. ' || AUX.TIPO_DE_FALTA || '  ' || AUX.CODIGO_EXPEDIENTE);
        CONTADOR := CONTADOR +1;
    END LOOP;
END;
/

EXECUTE LISTADO_CLIEN('11111111A');

/* 7 */

create or replace FUNCTION NUM_TRA(DNI_JU VARCHAR)
RETURN NUMBER
IS
    TOTAL NUMBER;
BEGIN
    SELECT COUNT(*) INTO TOTAL
    FROM OCULTA
    WHERE JUEZ_DNI = DNI_JU;

    RETURN TOTAL;
END;

/* 8 */

CREATE OR REPLACE PROCEDURE LISTADO_JUECES (DNI_J VARCHAR)
IS
    CURSOR AUX_CUR IS
        SELECT NOMBRE, APELLIDOS, FAMILIARES, CODIGO, NUM_TRA(DNI_J) AS TIPO
        FROM JUEZ
        WHERE DNI_JUEZ = DNI_J;

        ESTADO VARCHAR(20);
        CONTADOR NUMBER := 0;
BEGIN
    DBMS_OUTPUT.PUT_LINE('EL JUEZ CON DNI: ' || DNI_J);
    DBMS_OUTPUT.PUT_LINE('---------------------------');
    
    FOR AUX IN AUX_CUR LOOP
        IF AUX.TIPO = 0 THEN
            ESTADO := 'IMPECABLE';
        ELSIF AUX.TIPO < 3 THEN
            ESTADO:= 'POCO CORRUPTO';
        ELSE
            ESTADO:= 'MUY CORRUPTO';
        END IF;
        
        DBMS_OUTPUT.PUT_LINE(AUX.NOMBRE ||' ' || AUX.APELLIDOS || ' ' || AUX.FAMILIARES || ' ' || AUX.CODIGO || ' ' || ESTADO);
    END LOOP;
END;
/

EXECUTE LISTADO_JUECES('44444444B');